<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <style>
    .main {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }

    .card {
      position: relative;
      width: 200px;
      background: white;
      transition: .3s ease;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 1em;
      text-align: center;
    }

    .heading {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 0.5em;
    }

    .details {
      font-size: 0.9em;
      margin-bottom: 0.5em;
    }

    .price {
      font-weight: bold;
      margin-bottom: 0.5em;
    }

    .btn-editar {
      padding: 6px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8em;
      width: 90%;
    }

    .btn-editar:hover {
      background-color: #0056b3;
    }

    .form-container {
      display: none;
      flex-wrap: wrap;
      gap: 2em;
      justify-content: center;
      padding: 2em;
    }

    form {
      width: 250px;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 10px;
      background: #f9f9f9;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    .mensagem {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="main">
  <div class="card">
    <div class="heading">Soja</div>
    <div class="details" id="detalhes-soja">Estoque Atual: -- <br> Meta: -- <br> Recebimento: --</div>
    <div class="price" id="preco-soja">R$: --</div>
    <button onclick="mostrarFormulario('formSoja')" class="btn-editar">Editar</button>
  </div>

  <div class="card">
    <div class="heading">Milho</div>
    <div class="details" id="detalhes-milho">Estoque Atual: -- <br> Meta: -- <br> Recebimento: --</div>
    <div class="price" id="preco-milho">R$: --</div>
    <button onclick="mostrarFormulario('formMilho')" class="btn-editar">Editar</button>
  </div>
</div>

<!-- Container único com os formulários -->
<div class="form-container">
  <!-- Formulário Soja -->
  <form id="formSoja" style="display:none;">
    <h2>Cadastro Soja</h2>
    <label for="estoque">Estoque Atual:</label>
    <input type="number" id="estoque" required>

    <label for="meta">Meta:</label>
    <input type="number" id="meta" required>

    <label for="recebimento">Recebimento:</label>
    <input type="number" id="recebimento" required>

    <label for="percentual_metal">Percentual Meta:</label>
    <input type="number" id="percentual_metal" required>

    <button type="submit">Salvar</button>
    <div class="mensagem" id="mensagem"></div>
  </form>

  <!-- Formulário Milho -->
  <form id="formMilho" style="display:none;">
    <h2>Cadastro Milho</h2>
    <label for="estoque_milho">Estoque Atual:</label>
    <input type="number" id="estoque_milho" required>

    <label for="meta_milho">Meta:</label>
    <input type="number" id="meta_milho" required>

    <label for="recebimento_milho">Recebimento:</label>
    <input type="number" id="recebimento_milho" required>

    <label for="percentual_metal_milho">Percentual Meta:</label>
    <input type="number" id="percentual_metal_milho" required>

    <button type="submit">Salvar</button>
    <div class="mensagem" id="mensagem_milho"></div>
  </form>
</div>

<script>
  function mostrarFormulario(id) {
    const forms = document.querySelectorAll('.form-container form');
    forms.forEach(form => form.style.display = 'none');
    document.querySelector('.form-container').style.display = 'flex';
    document.getElementById(id).style.display = 'block';
  }
</script>

<!-- Script Supabase -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    "https://dylziaqkyavkfwjepqkp.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bHppYXFreWF2a2Z3amVwcWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTc1OTgsImV4cCI6MjA2ODAzMzU5OH0.gy5jXxKOTgeCf0Rwq7ktLTz1pyoZ8dJjZOK9UB9rHCM"
  );

  const formSoja = document.getElementById('formSoja');
  const formMilho = document.getElementById('formMilho');
  const msgSoja = document.getElementById('mensagem');
  const msgMilho = document.getElementById('mensagem_milho');

  async function carregarCard() {
    try {
      // Soja
      const { data: dataSoja } = await supabase
        .from('soja')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(1);

      if (dataSoja?.length > 0) {
        const s = dataSoja[0];
        document.getElementById('detalhes-soja').innerHTML = `
          Estoque Atual: ${s.estoqueatual.toLocaleString()} <br>
          Meta: ${s.meta.toLocaleString()} <br>
          Recebimento: ${s.recebimento.toLocaleString()}`;
        document.getElementById('preco-soja').innerText = `R$: ${s.percentual_metal.toFixed(2)}`;
        document.getElementById('estoque').value = s.estoqueatual;
        document.getElementById('meta').value = s.meta;
        document.getElementById('recebimento').value = s.recebimento;
        document.getElementById('percentual_metal').value = s.percentual_metal;
      }

      // Milho
      const { data: dataMilho } = await supabase
        .from('milho')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(1);

      if (dataMilho?.length > 0) {
        const m = dataMilho[0];
        document.getElementById('detalhes-milho').innerHTML = `
          Estoque Atual: ${m.estoqueatual.toLocaleString()} <br>
          Meta: ${m.meta.toLocaleString()} <br>
          Recebimento: ${m.recebimento.toLocaleString()}`;
        document.getElementById('preco-milho').innerText = `R$: ${m.percentual_metal.toFixed(2)}`;
        document.getElementById('estoque_milho').value = m.estoqueatual;
        document.getElementById('meta_milho').value = m.meta;
        document.getElementById('recebimento_milho').value = m.recebimento;
        document.getElementById('percentual_metal_milho').value = m.percentual_metal;
      }

    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    }
  }

  window.addEventListener('DOMContentLoaded', carregarCard);

  formSoja.addEventListener('submit', async (e) => {
    e.preventDefault();
    const estoque = parseFloat(document.getElementById('estoque').value);
    const meta = parseFloat(document.getElementById('meta').value);
    const recebimento = parseFloat(document.getElementById('recebimento').value);
    const percentual = parseFloat(document.getElementById('percentual_metal').value);

    const { error } = await supabase.from('soja').insert([{
      estoqueatual: estoque,
      meta: meta,
      recebimento: recebimento,
      percentual_metal: percentual,
      timestamp: new Date().toISOString()
    }]);

    msgSoja.innerHTML = error
      ? `<span style="color:red;">Erro: ${error.message}</span>`
      : `<span style="color:green;">Dados salvos com sucesso!</span>`;

    if (!error) {
      formSoja.reset();
      carregarCard();
    }
  });

  formMilho.addEventListener('submit', async (e) => {
    e.preventDefault();
    const estoque = parseFloat(document.getElementById('estoque_milho').value);
    const meta = parseFloat(document.getElementById('meta_milho').value);
    const recebimento = parseFloat(document.getElementById('recebimento_milho').value);
    const percentual = parseFloat(document.getElementById('percentual_metal_milho').value);

    const { error } = await supabase.from('milho').insert([{
      estoqueatual: estoque,
      meta: meta,
      recebimento: recebimento,
      percentual_metal: percentual,
      timestamp: new Date().toISOString()
    }]);

    msgMilho.innerHTML = error
      ? `<span style="color:red;">Erro: ${error.message}</span>`
      : `<span style="color:green;">Dados salvos com sucesso!</span>`;

    if (!error) {
      formMilho.reset();
      carregarCard();
    }
  });
</script>

</body>
</html>
